\documentclass[a4paper]{article}

\usepackage[cm]{fullpage}
\usepackage{graphicx}
\usepackage{upgreek}
\usepackage{amsmath}
\usepackage{verbatim}
\usepackage{csquotes}
\usepackage[dvipsnames]{xcolor}
\usepackage{bm}
\usepackage{url}
\usepackage{listings}
\lstset{ 
  language=Python,
  backgroundcolor=\color{white},   % choose the background color; you must add \usepackage{xcolor}; should come as last argument
  basicstyle=\footnotesize,        % the size of the fonts that are used for the code
  breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
  breaklines=true,                 % sets automatic line breaking
  captionpos=b,                    % sets the caption-position to bottom
  frame=single,                    % adds a frame around the code
  keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code 
  keywordstyle=\color{blue},       % keyword style
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title{MEEUUW \\ Mantle modelling Early Earth Utrecht University Work in progress}
\author{C. Thieulot} %, A. van den Berg}


\usepackage[style=authoryear,maxnames=1]{biblatex}
\addbibresource{bibliography.bib}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
\maketitle
\begin{center}
\includegraphics[width=3cm]{IMAGES/meeuuw}
\end{center}

%==============================================================================
\section{Foreword}

I have quite a history of naming codes and regretting it afterwards. This 
is one more in my collection: SoPHa, SPHene, FANTOM, ELEFANT, FLAPS, FieldStone.

%==============================================================================
\section{Install process}

The code consists of a dozen of Python files. 
Aside from standard Python modules (numpy, scipy, etc ...) the 
numba\footnote{\url{https://numba.pydata.org/}} package is needed and needs to be installed.
The reason for the use of this module is as follows: 
``Numba translates Python functions to optimized machine code at runtime using the industry-standard LLVM compiler library. Numba-compiled numerical algorithms in Python can approach the speeds of C or FORTRAN.
You don't need to replace the Python interpreter, run a separate compilation step, or even have a C/C++ compiler installed. Just apply one of the Numba decorators to your Python function, and Numba does the rest.'' [Taken from the numba website]

If numba is not available on your machine, simply delete all occurences of 
\lstinline{@numba.njit} before the functions.


%==============================================================================
\section{Philosophy}

The code is entirely written in Python. The domain is only 2d, although
an axisymmetric option has been implemented.
The code is not meant to compete with ASPECT or any similar code. It is 
meant to be an educational tool, typically for MSc or PhD students in mind. 
The interface is simple and flexible. 
Inside a \lstinline{experimentX.py} file the user needs to specify the 
necessary parameters (e.g. the resolution, domain size, number of timesteps, etc ...)
and fill in a few template functions:
\begin{lstlisting}  
initial_temperature
assign_boundary_conditions_V
assign_boundary_conditions_T
particle_layout
material_model
gravity_model
\end{lstlisting}  

There are at the moment 10 so-called experiments (called cookbooks in ASPECT)
that either aim at reproducing existing articles results (numerical benchmarks)
or built as setups to be used in class.
Each experiment is entirely contained in its corresponding \lstinline{experimentX.py} file.
The current list of experiments is as follows:
\begin{lstlisting}  
# experiment  0: Blankenbach et al, 1993 - isoviscous convection
# experiment  1: van Keken et al, JGR, 1997 - Rayleigh-Taylor experiment
# experiment  2: Schmeling et al, PEPI 2008 - Newtonian subduction
# experiment  3: Tosi et al, 2015 - visco-plastic convection
# experiment  4: not sure. mantle size convection
# experiment  5: Trompert & Hansen, Nature 1998 - convection w/ plate-like  
# experiment  6: Crameri et al, GJI 2012 (cosine perturbation & plume) 
# experiment  7: ESA workshop
# experiment  8: quarter - sinker
# experiment  9: axisymmetric Mars setup
# experiment 10: axisymmetric aspect benchmark of Stokes sphere
\end{lstlisting}  
The results obtained with the code for these experiments are 
available in the {\tt RESULTS} folder.

In order to select one of these experiments, simply open \lstinline{meeuuw.py}
and edit line 55 which reads \lstinline{experiment=X}.

In order to run the code, simply then type the following in the terminal:
\begin{verbatim}
python3 meeuuw.py
\end{verbatim}
Note that a script carrying this also exists and can be executed as follows:
\begin{verbatim}
./run
\end{verbatim}

The code will then run and will produce {\it a lot} of information 
while running in the terminal. If you wish to keep this information 
you can redirect the screen output to a file as follows for example:
\begin{verbatim}
python3 meeuuw.py > screen_output.text
\end{verbatim}
The code also generates {\tt .ascii} files (to be plotted with gnuplot for example)
and {\tt .vtu} files to be opened with ParaView. All are placed automatically 
in the {\tt OUTPUT} folder.

After a simulation, if results are to be discarded, and before running a new 
model, it is recommended to remove all results by running the following script:
\begin{verbatim}
./cleandata
\end{verbatim}



%==============================================================================
\section{Numerical methods}

The Stokes equations are discretised by means of the Finite Element Method (FEM).
As explained in \textcite{thba22} and \textcite{thba22}, there are many 
so-called element pairs for the velocity and pressure spaces, and we here rely 
on quadrilateral Taylor-Hood elements only, i.e. $Q_2 \times Q_1$.
The energy equation relies on $Q_2$ elements for the temperature.

The FEM formulation of these equations is explained in the FieldStone 
manual\footnote{\url{https://cedrict.github.io/}}.

\newpage
%==============================================================================
\section{Code structure}

\verbatiminput{structure}


\newpage
%==============================================================================
\section{Generic mass, momentum, energy conservation equations}

We focus on the system of equations in a $d=2$- or $d=3$-dimensional
domain $\Omega$ that describes the motion of a highly viscous fluid (i.e.
near infinite Prandlt number) driven
by differences in the gravitational force due to a density variations. 
In the following, we largely follow the exposition of this
material in Schubert, Turcotte and Olson \cite{scto01}.

Specifically, we consider the following set of equations for 
velocity $\vec\upnu$, pressure $p$ and temperature $T$:
\begin{align}
  \label{eq:stokes-1}
  - \vec\nabla p +  
  \vec\nabla \cdot \left[2\eta \left(\dot{\bm \varepsilon}(\vec \upnu)
                                  - \frac{1}{3}(\vec\nabla \cdot \vec \upnu)\mathbf 1\right)
                \right] +  \rho \vec g &= \vec{0}
  &
  & \textrm{in $\Omega$},
  \\
  \label{eq:stokes-2}
  \frac{\partial \rho}{\partial t} + \vec\nabla \cdot (\rho \vec \upnu) &= 0
  &
  & \textrm{in $\Omega$},
  \\
  \label{eq:temperature}
  \rho C_p \left(\frac{\partial T}{\partial t} + \vec \upnu\cdot\vec\nabla T\right)
  - \vec\nabla\cdot k\vec\nabla T
  &=
  \rho H
  \notag
  \\
  &\quad
  +
  2\eta
  \left(\dot\varepsilon(\vec\upnu) - \frac{1}{3}(\vec\nabla \cdot \vec \upnu)\mathbf 1\right)
  :
  \left(\dot\varepsilon(\vec\upnu) - \frac{1}{3}(\vec\nabla \cdot \vec \upnu)\mathbf 1\right)
  \\
  &\quad
  %+\alpha T \left( \vec \upnu \cdot \vec\nabla p \right)
  +\alpha T \left( \frac{\partial p}{\partial t} +  \vec \upnu \cdot \vec\nabla p \right)
  && \textrm{in $\Omega$},
\end{align}
where $\dot{\bm \varepsilon}(\vec\upnu) = \frac{1}{2}(\vec\nabla \vec\upnu + \vec\nabla \vec\upnu^T)$
is the symmetric gradient of the velocity (often called the
\textit{strain rate} tensor).

In this set of equations, \eqref{eq:stokes-1} and \eqref{eq:stokes-2}
represent the compressible Stokes equations in which $\vec\upnu =\vec\upnu (\mathbf x,t)$
is the velocity field and $p=p(\mathbf x,t)$ the pressure
field. Both fields depend on space $\mathbf x$ and time $t$. Fluid flow is
driven by the gravity force that acts on the fluid and that is proportional to
both the density of the fluid and the strength of the gravitational pull.

Coupled to this Stokes system is equation \eqref{eq:temperature} for the
temperature field $T=T(\mathbf x,t)$ that contains heat conduction terms as
well as advection with the flow velocity $\vec{\upnu}$. The right hand side
terms of this equation correspond to
\begin{itemize}
\item internal heat production for example due to radioactive decay;
\item friction (shear) heating;
\item adiabatic compression of material;
\end{itemize}


\newpage
%==============================================================
\section{Equation of state}

%taken from mayu07
The equation of state gives the density as a function of the
pressure and temperature: $\rho=\rho(p,T)$.
The density is then either obtained from precomputed lookup
tables or a simpler functional approach is often taken
by means of a linearisation.

The widely used Boussinesq approximation (see below) linearizes these
basic conservation laws near the reference hydrostatic state.
If density changes caused by the pressure deviations
$p' = p-p_0$ are neglected, we may linearize the state equation with respect to
the temperature deviations $T-T_0$, where $T_0$ is a reference
temperature, and write:
\[
\rho=\rho_0(1-\alpha(T-T_0))
\]
This approximation thus means that the influence of hydrostatic pressure 
(as well as temperature $T_0$) on density is hidden
in a spatial dependence of the reference density $\rho_0$.

The reference density $\rho_0$ is assumed to be a time-independent function. 
Considering only the largest term in the equation of continuity, that is, 
neglecting thermal expansion, we arrive at the simplified equation:
\[
\vec\nabla\cdot(\rho_0 \vec\upnu) =0
\]


\newpage
%==============================================================
\section{Anelastic liquid approximation (ALA)}

This comes from \textcite{mayu07}.

If we assume that there is a reference hydrostatic state characterized 
by $\vec\upnu = 0$ in which the hydrostatic pressure $p_0$, 
hydrostatic density $\rho_0$, and hydrostatic gravity acceleration $g_0$ are
related by $\vec\nabla p_0 = \rho_0 \vec{g}_0$,
and moreover that pressure deviations $p'=p-p_0$
are negligible in the heat equation, the transfer of heat in a homogeneous
material (i.e., entropy may be considered as a function of only
p and T) is then described by the well-known equation:
\[
\rho C_p \left( \frac{\partial T}{\partial t} + \vec \upnu\cdot\vec\nabla T\right)
=  \vec\nabla\cdot k\vec\nabla T  
- \alpha T  \vec\upnu \cdot \rho \vec{g} 
+ {\bm \tau} : \vec\nabla \vec\upnu + Q
\]
where $C_p$ is the isobaric speciﬁc heat, $\alpha$ is the thermal expansion
coefﬁcient and vr denotes the radial component of velocity. The
left-hand side of equation 8 represents local changes of heat balance; 
the second (third) term on the right-hand side describes ad-
vection of heat (adiabatic heating and/or cooling).



\newpage
%==============================================================
\section{Boussinesq approximation (BA)}

In the case of an incompressible flow, then $\partial \rho/\partial t=0$ and
${\vec \nabla}\rho=0$, i.e. $D\rho/Dt=0$ and the mass conservation equation becomes:
\[
{\vec \nabla}\cdot{\vec \upnu} = 0
\]
A vector field that is divergence-free is also called
solenoidal\footnote{\url{https://en.wikipedia.org/wiki/Solenoidal_vector_field}}.

In this case the equations above can now be written

\begin{align}
  - \vec\nabla p +  
  \vec\nabla \cdot \left[2\eta \left(\dot{\bm \varepsilon}(\vec \upnu)  \right)
                \right] +  \rho \vec g &= \vec{0}
  &
  & \textrm{in $\Omega$},
  \\
  \vec\nabla \cdot \vec \upnu &= 0
  &
  & \textrm{in $\Omega$},
  \\
  \rho C_p \left(\frac{\partial T}{\partial t} + \vec \upnu\cdot\vec\nabla T\right)
  - \vec\nabla\cdot k\vec\nabla T
  &=
  \rho H
  +
  2\eta \dot\varepsilon(\vec\upnu) : \dot\varepsilon(\vec\upnu) 
  %+\alpha T \left( \vec \upnu \cdot \vec\nabla p \right)
  +\alpha T \left( \frac{\partial p}{\partial t} +  \vec \upnu \cdot \vec\nabla p \right)
  && \textrm{in $\Omega$},
\end{align}

\noindent As nicely explained in \textcite{spve60}: 
\begin{displayquote}
{\color{darkgray}
In the study of problems of thermal convection it is a frequent practice to simplify the basic 
equations by introducing certain approximations which are attributed to
Boussinesq (1903). The Boussinesq approximations can best be summarized by two
statements: 
\begin{enumerate}
\item The fluctuations in density which appear with the advent of motion
result principally from thermal (as opposed to pressure) effects. 
\item In the equations
for the rate of change of momentum and mass, density variations may be neglected except
when they are coupled to the gravitational acceleration in the buoyancy force."
\end{enumerate}
}
\end{displayquote}
Note that their paper examines the Boussinesq approximation for compressible fluids.  

The Boussinesq approximation assumes that the density can be
considered constant in all occurrences in the equations with the exception of
the buoyancy term on the right hand side of \eqref{eq:stokes-1}. The primary
result of this assumption is that the continuity equation \eqref{eq:stokes-2}
will now read ${\vec \nabla}\cdot{\vec \upnu} = 0$.
This implies that the strain rate tensor is deviatoric.
Under the Boussinesq approximation, the equations are much simplified:

\begin{align}
  -\vec\nabla p + \vec\nabla \cdot \left[2\eta \dot{\bm \varepsilon}(\vec\upnu) \right] + \rho \vec{g} &= \vec{0}
  &
  & \textrm{in $\Omega$},  \\
  \vec\nabla \cdot  \vec\upnu &= 0 
  &
  & \textrm{in $\Omega$},
  \\
  \rho_0 C_p \left(\frac{\partial T}{\partial t} + \vec\upnu \cdot\vec\nabla T\right)
  - \vec\nabla\cdot k\vec\nabla T
  &=
  \rho H
  &
  & \textrm{in $\Omega$}
\end{align}
Note that all terms on the rhs of the temperature equations have disappeared, with the exception 
of the source term.

In \textcite{vacp22} we read: 
\begin{displayquote}
The Boussinesq approximation (\textcite{ober79}; Boussinesq, 1903; Rayleigh, 1916) 
assumes that density
variations are so small that they can be neglected everywhere
except in the buoyancy term in the momentum equation, 
which is equivalent to using a constant reference density profile. 
This implies incompressibility [...]. In addition, adiabatic heating
and shear heating are not considered in the energy equation. 
This approximation is valid as long as density variations are small 
and the modelled processes would cause no substantial 
shear or adiabatic heating.
The Boussinesq approximation is often used in lithosphere-
scale models. Due to its simplicity, the approximation of in-
compressibility is sometimes also adopted for whole-mantle
convection models, wherein it is only approximately valid,
and it has been shown that compressibility can have a large
effect on the pattern of convective flow \cite{tack96}.
\end{displayquote}





\newpage
%==============================================================
\section{Extended Boussinesq approximation (EBA)}

In \textcite{vacp22} we read: 
\begin{displayquote}
The extended Boussinesq approximation (\cite{chyu85,oxtu78}) is based
on the same assumptions as the BA but does consider adiabatic 
and shear heating. Since it includes adiabatic heating,
but not the associated volume and density changes, it can
lead to artificial changes of energy in the model, i.e. material 
is being heated or cooled based on the assumption that
it is compressed or it expands, but the mechanical work that
causes compression or expansion is not done. Consequently,
the extended Boussinesq approximation should only be used
in models without substantial adiabatic temperature changes.

For a comparison between some of these approximations
using benchmark models, see e.g. \textcite{sthe89},
\textcite{lezh08}, \textcite{kilv10}, \textcite{gadb20}. 
In addition, the choice of approximation may
also be limited by the numerical methods being employed
(for example, the accuracy of the solution for the variables
that affect the density). Also note that, technically, these 
approximations are all internally inconsistent to varying 
degrees, since they do not fulfil the definitions of
thermodynamic variables but use linearised versions instead,
and they use different density formulations in the different 
equations. Nevertheless, many of them are generally accepted 
and widely used in geodynamic modelling studies, as
they allow for simpler equations and more easily obtained solutions.
\end{displayquote}

%==============================================================================
\section{Initial adiabatic temperature profile}




%==============================================================================
\section{Dynamic topography}








%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\printbibliography

\end{document}

